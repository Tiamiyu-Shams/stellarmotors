{% extends "base.html" %}
{% block title %}{{ car['title'] }} Details{% endblock %}

{% block content %}

<!-- FontAwesome Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<div class="max-w-5xl mx-auto bg-white rounded-xl shadow-lg p-6 my-8">
  
  <!-- Car Title -->
  <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center flex items-center justify-center gap-3">
      <i class="fa-solid fa-car text-blue-700"></i>
      {{ car['title'] }}
  </h2>

  <!-- Image Gallery -->
  <div class="relative">
    <button id="galleryPrev"
      class="absolute -left-6 top-1/2 transform -translate-y-1/2 z-20 bg-white shadow-lg rounded-full p-3 text-xl hover:bg-gray-200">
      <i class="fa-solid fa-chevron-left"></i>
    </button>

    <button id="galleryNext"
      class="absolute -right-6 top-1/2 transform -translate-y-1/2 z-20 bg-white shadow-lg rounded-full p-3 text-xl hover:bg-gray-800 hover:text-white">
      <i class="fa-solid fa-chevron-right"></i>
    </button>

    <div id="carGallery" class="flex overflow-x-auto gap-4 pb-2 scroll-smooth snap-x snap-mandatory px-6">
      {% for img in car_images %}
      <div class="snap-center shrink-0">
        <img class="gallery-thumb rounded-lg border w-96 h-72 object-cover cursor-pointer"
             src="{{ img['image_path'] }}" 
             data-src="{{ img['image_path'] }}">
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- Car Info -->
  <div class="mt-6 grid sm:grid-cols-2 gap-4 text-gray-700">
    <p><strong>Description:</strong> {{ car['description'] or '—' }}</p>
    <p><strong>Price:</strong> ₦{{ "{:,.0f}".format(car['price']|float) }}</p>
    <p><strong>Mileage:</strong> {{ car['mileage'] or '—' }} km</p>
    <p><strong>Body Condition:</strong> {{ car['body_condition'] or '—' }}</p>
    <p><strong>Fuel Efficiency:</strong> {{ car['fuel_efficiency'] or '—' }}</p>
    <p><strong>Engine Performance:</strong> {{ car['engine_performance'] or '—' }}</p>
    <p><strong>Category:</strong> {{ car['category'] or '—' }}</p>
    <p><strong>Added:</strong> {{ car['date_added'] or '—' }}</p>
  </div>

  <!-- Seller Section -->
  <div class="border-t pt-6 mt-10">
    <h3 class="text-2xl font-semibold mb-4 flex items-center gap-2">
      <i class="fa-solid fa-user text-blue-700"></i> Seller Information
    </h3>

    {% if seller %}
    <div class="flex flex-col sm:flex-row gap-5 items-center sm:items-start">
      <img src="{{ car['seller_photo'] }}" class="w-24 h-24 rounded-full border object-cover">
      

      <div>
        <p><span class="font-bold text-lg">{{ seller['name'] }}:</span> {{ seller.phone }}</p>

        <!-- Click-to-Copy Phone -->
        <p class="text-gray-600 text-sm mt-1 flex items-center gap-2">
          <i class="fa-solid fa-phone text-green-600"></i>
          <span id="copyPhone" class="cursor-pointer" onclick="copyPhoneNumber()">
            {{ seller['contact_info'] }}
          </span>
          <i class="fa-solid fa-copy text-gray-400 cursor-pointer" onclick="copyPhoneNumber()"></i>
          <span>{{ seller['contact_info'] }}</span>
        </p>

        <!-- Action Buttons -->
        <div class="flex gap-3 mt-4">

          <!-- Call Button -->
          <a href="tel:{{ seller['contact_info'] }}"
            class="bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-blue-700">
            <i class="fa-solid fa-phone"></i> Call
          </a>

          <!-- WhatsApp Button -->
          <a href="https://wa.me/{{ seller['contact_info'] }}?text=Hello%20I%20am%20interested%20in%20your%20car%20-%20{{ car['title'] }}"
            target="_blank"
            class="bg-green-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-green-700">
            <i class="fa-brands fa-whatsapp"></i> WhatsApp
          </a>

          <!-- Email Button -->
          <a href="mailto:{{ seller['email'] }}?subject=Inquiry%20About%20{{ car['title'] }}"
            class="bg-red-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-red-700">
            <i class="fa-solid fa-envelope"></i> Email
          </a>

        </div>
      </div>
    </div>

    {% else %}
    <p class="text-gray-500">Seller information not available.</p>
    {% endif %}
  </div>

  <!-- Send Message Form -->
  <div class="border-t pt-8 mt-10">
    <h3 class="text-2xl font-semibold mb-4 flex items-center gap-2">
      <i class="fa-solid fa-message text-blue-700"></i> Send a Message
    </h3>

    <form action="{{ url_for('main.send_message') }}" method="POST" class="grid gap-4">

      <input type="text" name="name" class="border p-3 rounded-lg" placeholder="Your Name" required>

      <input type="email" name="email" class="border p-3 rounded-lg" placeholder="Your Email" required>

      <textarea name="message" class="border p-3 rounded-lg" rows="4" placeholder="Your Message"
        required></textarea>

      <!-- Hidden Fields -->
      <input type="hidden" name="seller_phone" value="{{ seller['contact_info'] }}">
      <input type="hidden" name="seller_email" value="{{ seller['email'] }}">
      <input type="hidden" name="seller_name" value="{{ seller['name'] }}">
      <input type="hidden" name="car_title" value="{{ car['title'] }}">

      <button class="bg-blue-700 text-white py-3 rounded-lg font-semibold hover:bg-blue-800 flex items-center justify-center gap-2">
        <i class="fa-solid fa-paper-plane"></i> Send Message
      </button>
    </form>
  </div>

</div>

<!-- Image Modal -->
<div id="imageModal"
     class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50">
  <img id="modalImage" class="max-h-[90vh] max-w-[90vw] rounded-lg shadow-lg border-4 border-white">
</div>

<!-- Click to Copy Script -->
<script>
function copyPhoneNumber() {
    const phone = "{{ seller['contact_info'] }}";
    navigator.clipboard.writeText(phone);
    alert("Phone number copied: " + phone);
}
</script>

<!-- Gallery + Pinch Zoom Script -->
<script>
(function() {
  const gallery = document.getElementById('carGallery');
  const prevBtn = document.getElementById('galleryPrev');
  const nextBtn = document.getElementById('galleryNext');
  const modal = document.getElementById('imageModal');
  const modalImage = document.getElementById('modalImage');
  const SCROLL_AMOUNT = 420;

  prevBtn.addEventListener('click', () => gallery.scrollBy({ left: -SCROLL_AMOUNT, behavior: 'smooth' }));
  nextBtn.addEventListener('click', () => gallery.scrollBy({ left: SCROLL_AMOUNT, behavior: 'smooth' }));

  document.querySelectorAll('.gallery-thumb').forEach(img => {
    img.addEventListener('click', () => {
      modalImage.src = img.dataset.src;
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      document.body.style.overflow = 'hidden';
      resetZoom();
    });
  });

  modal.addEventListener('click', e => {
    if (e.target === modal) closeModal();
  });

  function closeModal() {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    modalImage.src = '';
    document.body.style.overflow = '';
    resetZoom();
  }

  /* Pinch-to-Zoom */
  let scale = 1;
  let startDist = 0;

  modalImage.addEventListener('touchstart', e => {
    if (e.touches.length === 2) {
      startDist = getDist(e.touches);
    }
  });

  modalImage.addEventListener('touchmove', e => {
    if (e.touches.length === 2) {
      e.preventDefault();
      const newDist = getDist(e.touches);
      scale = Math.min(Math.max(1, newDist / startDist), 3);
      modalImage.style.transform = `scale(${scale})`;
    }
  }, { passive: false });

  function getDist(t) {
    return Math.hypot(t[0].pageX - t[1].pageX, t[0].pageY - t[1].pageY);
  }

  function resetZoom() {
    scale = 1;
    modalImage.style.transform = 'scale(1)';
  }
})();
</script>

<style>
  #galleryPrev, #galleryNext {
    width: 50px;
    height: 50px;
    display: grid;
    place-items: center;
  }

  @media (max-width: 768px) {
    #galleryPrev { left: 8px; }
    #galleryNext { right: 8px; }
    .gallery-thumb { width: 85vw !important; height: 60vw !important; }
  }
</style>

{% endblock %}
